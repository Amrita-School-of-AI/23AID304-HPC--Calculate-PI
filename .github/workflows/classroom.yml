name: Autograding Tests
on:
  - push
  - workflow_dispatch
  - repository_dispatch
permissions:
  checks: write
  actions: read
  contents: read
jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      # 2. Install OMP and C++ compiler
    - name: Set up C++ and OMP environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libomp-dev
    
    - name: 1. Compiles successfully
      uses: classroom-resources/autograding-io-grader@v1
      id: compiles-successfully
      with:
        test-name: 1. Compiles successfully (10 points)
        command: gcc -o pi_calculator pi_calculator.c -fopenmp -lm && echo 'Compilation successful.' || echo 'Compilation failed.' 
        expected-output: 'Compilation successful.'
        comparison-method: exact
        timeout: 2
        max-score: 10

    - name: 2. Runs and calculates Pi correctly
      uses: classroom-resources/autograding-io-grader@v1
      id: calculates-pi-correctly
      with:
        test-name: 2. Runs and calculates Pi correctly (40 points)
        setup-command: gcc -o pi_calculator pi_calculator.c -fopenmp -lm
        command: ./pi_calculator
        expected-output: 'Calculated Pi\s*=\s*3\.14159\d*\nExecution time:.*'
        comparison-method: regex
        timeout: 2
        max-score: 40

    - name: 3. Outputs execution time
      uses: classroom-resources/autograding-io-grader@v1
      id: execution-time
      with:
        test-name: 3. Outputs execution time (10 points)
        command: cat ./pi_calculator.c 
        expected-output: '.*#pragma\s+omp\s+parallel.*'
        comparison-method: regex
        timeout: 2
        max-score: 10

    - name: 4. Achieves speedup over serial version
      uses: classroom-resources/autograding-io-grader@v1
      id: speedup-over-serial
      with: 
        test-name: 4. Achieves speedup over serial version (20 points)
        setup-command: chmod a+x ./test.sh
        command: ./test.sh
        expected-output: 'Success: Parallel version is faster.'
        comparison-method: exact
        timeout: 3
        max-score: 20
        
    - name: Autograding Reporter
      uses: classroom-resources/autograding-grading-reporter@v1
      env:
        COMPILES-SUCCESSFULLY_RESULTS: "${{steps.compiles-successfully.outputs.result}}"
        CALCULATES-PI-CORRECTLY_RESULTS: "${{steps.calculates-pi-correctly.outputs.result}}"
        EXECUTION-TIME_RESULTS: "${{steps.execution-time.outputs.result}}"
        SPEEDUP-OVER-SERIAL_RESULTS: "${{steps.speedup-over-serial.outputs.result}}"
      with:
        runners: compiles-successfully, calculates-pi-correctly, execution-time, speedup-over-serial